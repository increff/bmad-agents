name: notion-test-workflow
version: 1.0.0
description: "Automated workflow to test Notion API connectivity and configuration"

# Workflow metadata
metadata:
  author: "BMAD Notion Integration"
  category: "testing"
  tags: ["notion", "test", "connectivity", "validation"]

# Workflow inputs
inputs:
  detailed:
    type: boolean
    description: "Run detailed connectivity tests"
    required: false
    default: true
  
  check_schema:
    type: boolean
    description: "Validate database schema and field mappings"
    required: false
    default: true

# Environment configuration
environment:
  load_from: ".env"
  required_vars:
    - NOTION_API_KEY
    - NOTION_DATABASE_ID
  optional_vars:
    - NOTION_VIEW_ID

# Workflow steps
steps:
  - name: validate-environment
    description: "Check environment variables are present"
    action: validate-env
    inputs:
      required:
        - NOTION_API_KEY
        - NOTION_DATABASE_ID
    on_error: fail
    error_message: "Missing required environment variables in .env file"

  - name: test-api-connection
    description: "Test basic Notion API connectivity"
    action: execute-script
    script: "scripts/notion-test.js"
    command: "test-connection"
    on_error: fail
    timeout: 10s

  - name: test-database-access
    description: "Verify access to configured database"
    action: execute-script
    script: "scripts/notion-test.js"
    command: "test-database"
    on_error: fail

  - name: validate-schema
    description: "Validate database schema matches configuration"
    action: execute-script
    script: "scripts/notion-test.js"
    command: "validate-schema"
    skip_if: "{{inputs.check_schema}} == false"
    on_error: warn

  - name: test-sample-fetch
    description: "Test fetching sample data"
    action: execute-script
    script: "scripts/notion-test.js"
    command: "test-fetch"
    skip_if: "{{inputs.detailed}} == false"
    on_error: warn

  - name: test-field-mappings
    description: "Test field mapping configuration"
    action: execute-script
    script: "scripts/notion-test.js"
    command: "test-mappings"
    skip_if: "{{inputs.detailed}} == false"
    on_error: warn

  - name: generate-report
    description: "Generate test report"
    action: generate-report
    inputs:
      results:
        - "{{steps.test-api-connection.status}}"
        - "{{steps.test-database-access.status}}"
        - "{{steps.validate-schema.status}}"
      output_file: "docs/.notion-test-report.json"

# Outputs
outputs:
  all_tests_passed:
    value: "{{steps.test-api-connection.status}} == success && {{steps.test-database-access.status}} == success"
    description: "Whether all critical tests passed"
  
  test_report:
    value: "docs/.notion-test-report.json"
    description: "Detailed test report file"
  
  api_accessible:
    value: "{{steps.test-api-connection.status}}"
    description: "Notion API connectivity status"

# Success criteria
success:
  conditions:
    - step: test-api-connection
      status: success
    - step: test-database-access
      status: success
  message: "✅ All Notion connectivity tests passed!"

# Failure handling
failure:
  actions:
    - log_error: true
    - generate_diagnostic_report: true
  message: "❌ Notion connectivity tests failed. Check configuration."

